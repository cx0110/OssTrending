name: Daily OSSInsight Report

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

jobs:
  run-tracker:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Run Script
        env:
          TZ: 'Asia/Shanghai'
          # ‰ªé GitHub Secrets ËØªÂèñ
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          # ‰ªé GitHub Variables ËØªÂèñ (ÊàñËÄÖÁõ¥Êé•ÂÜô true/false)
          ENABLE_LLM: ${{ vars.ENABLE_LLM || 'false' }}
        run: python main.py

      - name: Commit & Push
        run: |
          git config --global user.name "gh-actions-bot"
          git config --global user.email "bot@noreply.github.com"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "update: daily report $(date +'%Y-%m-%d')"
            git push
          fi
          
      # === Êñ∞Â¢ûÊ≠•È™§ÔºöÊé®ÈÄÅÂà∞ Obsidian ‰ªìÂ∫ì (Repo B) ===
      - name: Push to Obsidian Vault
        uses: cpina/github-action-push-to-another-repository@main
        env:
          # ËÆ∞ÂæóÂú® Repo A ÁöÑ Secrets ÈáåÈÖçÁΩÆ API_TOKEN_GITHUB
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          # Êù•Ê∫êÔºö‰Ω†ÁöÑ Python ËÑöÊú¨ÁîüÊàêÁöÑÊñá‰ª∂Â§πÂêç (config‰∏≠ settings['archive_dir'] ÁöÑÂÄº)
          # ÈªòËÆ§‰∏∫ archives/ÔºåÂ¶ÇÊûú‰Ω†Ê≤°Êîπ config.yaml Â∞±ÊòØËøô‰∏™
          source-directory: 'archives/'
          
          # ÁõÆÊ†áÔºö‰Ω†ÁöÑ GitHub Áî®Êà∑Âêç
          destination-github-username: 'cx0110'
          
          # ÁõÆÊ†áÔºö‰Ω†ÁöÑ Obsidian ‰ªìÂ∫ìÂêç
          destination-repository-name: 'ob-note'
          
          # ‰Ω†ÁöÑÈÇÆÁÆ±
          user-email: 'github.cx0110@gmail.com'
          
          # ÁõÆÊ†áÂàÜÊîØ (ÈÄöÂ∏∏ÊòØ main Êàñ master)
          target-branch: main
          
          # „ÄêÂÖ≥ÈîÆ„ÄëÁõÆÊ†áË∑ØÂæÑÔºöÁ¨¶Âêà‰Ω†ÁöÑ PARA ÁªìÊûÑ
          # Ë≠¶ÂëäÔºöËøô‰∏™Êñá‰ª∂Â§πÂÜÖÁöÑÊóßÂÜÖÂÆπ‰ºöË¢´ source-directory ÁöÑÂÜÖÂÆπÂÆåÂÖ®Ë¶ÜÁõñ/ÂêåÊ≠•
          # ÊâÄ‰ª•ÂøÖÈ°ªÊåáÂÆö‰∏Ä‰∏™‰∏ìÂ±ûÁöÑÂ≠êÊñá‰ª∂Â§πÔºå‰∏çË¶ÅÁõ¥Êé•Â°´ 00_InboxÔºåÂê¶Âàô Inbox ÂÖ∂‰ªñÊñá‰ª∂‰ºöË¢´Âà†ÔºÅ
          target-directory: '90_Archives/Tech_News/OSSInsight'

      # Êé®ÈÄÅÂà∞ÂçöÂÆ¢ (ËøΩÂä†Ê®°Âºè)
      - name: Append to Hugo Blog
        env:
          BLOG_REPO_TOKEN: ${{ secrets.API_TOKEN_GITHUB }}
          BLOG_REPO: ${{ vars.BLOG_REPO }}
        run: |
          TODAY=$(date +'%Y-%m-%d')
          # ÂøÖÈ°ªÂíå Repo A ‰øùÊåÅÂÆåÂÖ®‰∏ÄËá¥ÁöÑÁõÆÂΩïÂêç
          POST_DIR="content/post/${TODAY}-daily-news"
          
          # 1. Clone ÂçöÂÆ¢‰ªìÂ∫ì
          git clone --depth 1 https://x-access-token:${BLOG_REPO_TOKEN}@github.com/${BLOG_REPO}.git blog
          
          TARGET_FILE="blog/${POST_DIR}/index.md"
          mkdir -p "blog/${POST_DIR}"
          
          # 2. Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú® (Èò≤Ê≠¢ Repo A ËøêË°åÂ§±Ë¥•)
          if [ ! -f "$TARGET_FILE" ]; then
            echo "‚ö†Ô∏è Repo A Â∞öÊú™ÂàõÂª∫Êñá‰ª∂ÔºåÊ≠£Âú®ÊâßË°åË°•ÊïëÂàõÂª∫..."
            cat > "$TARGET_FILE" << EOF
          ---
          title: "üî• ÊØèÊó•ÊäÄÊúØÁÉ≠ÁÇπ ${TODAY}"
          date: ${TODAY}T09:00:00+08:00
          draft: false
          ---
          EOF
          fi
          
          # 3. ËøΩÂä† Repo B ÁöÑÂÜÖÂÆπ
          # ÂÖàÂÜôÂÖ•‰∏Ä‰∏™ÂàÜÂâ≤Á∫øÂíåÊ†áÈ¢ò
          echo "" >> "$TARGET_FILE"
          echo "---" >> "$TARGET_FILE"
          echo "" >> "$TARGET_FILE"
          echo "## üî• OSSInsight ÊäÄÊúØÁÉ≠ÁÇπ" >> "$TARGET_FILE"
          echo "" >> "$TARGET_FILE"
          
          # ËøΩÂä†ÂÜÖÂÆπ (ÂÅáËÆæ‰Ω†ÁöÑËæìÂá∫Âú® archives/${TODAY}.md)
          if [ -f "archives/${TODAY}.md" ]; then
            sed '1{/^#/d;}' "archives/${TODAY}.md" >> "$TARGET_FILE"
          elif [ -f "README.md" ]; then
             sed '1{/^#/d;}' README.md >> "$TARGET_FILE"
          fi
          
          # 4. Êé®ÈÄÅ
          cd blog
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "üî• Append OSSInsight: ${TODAY}"
            git push
          fi
